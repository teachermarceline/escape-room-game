<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ” The Johnson Mystery â€” Escape Room</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#0a0e17;--card:#151b2b;--card2:#1e2538;--gold:#f5c518;--gold2:#c9a30a;
--red:#e94560;--green:#3fb950;--blue:#58a6ff;--txt:#e6edf3;--dim:#7a8599;
}
html,body{height:100%;overflow:hidden}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--txt)}
button{font-family:inherit;cursor:pointer;border:none;outline:none}
input{font-family:inherit;outline:none}

/* â”€â”€â”€ SCREENS â”€â”€â”€ */
.screen{position:fixed;inset:0;display:none;flex-direction:column;z-index:1}
.screen.active{display:flex}

/* â”€â”€â”€ INTRO â”€â”€â”€ */
#intro{background:linear-gradient(160deg,#0a0e17 0%,#14192a 50%,#0d1018 100%);
align-items:center;justify-content:center;text-align:center;padding:20px}
#intro::before{content:'';position:absolute;inset:0;
background:radial-gradient(circle at 50% 30%,rgba(245,197,24,.06) 0%,transparent 60%)}
.intro-badge{font-family:'Cinzel',serif;font-size:clamp(.7rem,1.5vw,.85rem);
letter-spacing:6px;color:var(--gold);margin-bottom:12px;text-transform:uppercase}
.intro-title{font-family:'Cinzel',serif;font-size:clamp(1.8rem,5vw,3.2rem);
font-weight:900;color:var(--gold);text-shadow:0 0 40px rgba(245,197,24,.3);
margin-bottom:24px;line-height:1.2}
.intro-story{max-width:640px;font-size:clamp(.88rem,2vw,1.05rem);line-height:1.8;
color:var(--dim);margin-bottom:32px;position:relative}
.intro-story em{color:var(--txt);font-style:normal;font-weight:600}
.intro-chars{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-bottom:36px}
.intro-char{background:var(--card);border-radius:14px;padding:14px 10px 10px;width:130px;
border:1px solid rgba(245,197,24,.1);text-align:center;transition:.3s}
.intro-char:hover{border-color:var(--gold);transform:translateY(-4px);
box-shadow:0 8px 30px rgba(245,197,24,.1)}
.intro-char img{width:64px;height:64px;border-radius:50%;object-fit:cover;
border:2px solid var(--gold2);margin-bottom:8px}
.intro-char .name{font-weight:600;font-size:.85rem}
.intro-char .role{font-size:.72rem;color:var(--dim)}
.btn-start{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#0a0e17;
font-family:'Cinzel',serif;font-weight:700;font-size:clamp(.95rem,2vw,1.15rem);
padding:16px 48px;border-radius:50px;letter-spacing:2px;text-transform:uppercase;
transition:.3s;box-shadow:0 4px 30px rgba(245,197,24,.3)}
.btn-start:hover{transform:scale(1.05);box-shadow:0 6px 40px rgba(245,197,24,.5)}

/* â”€â”€â”€ TOP BAR â”€â”€â”€ */
#topbar{background:rgba(10,14,23,.92);backdrop-filter:blur(12px);
border-bottom:1px solid rgba(245,197,24,.12);padding:10px 20px;
display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;
z-index:10;flex-shrink:0}
.tb-room{font-family:'Cinzel',serif;font-weight:700;font-size:clamp(.8rem,2vw,1rem);
color:var(--gold)}
.tb-group{display:flex;gap:12px;align-items:center}
.tb-item{display:flex;align-items:center;gap:5px;font-size:.8rem;
background:var(--card);padding:6px 12px;border-radius:20px;border:1px solid rgba(255,255,255,.06)}
.tb-item .icon{font-size:1rem}
#timer{font-weight:700;font-variant-numeric:tabular-nums}
#timer.warning{color:var(--red);animation:timerPulse 1s infinite}
@keyframes timerPulse{0%,100%{opacity:1}50%{opacity:.4}}
.tb-btn{background:var(--card2);color:var(--gold);padding:6px 14px;border-radius:20px;
font-size:.78rem;font-weight:600;border:1px solid rgba(245,197,24,.2);transition:.2s}
.tb-btn:hover{background:var(--gold);color:var(--bg)}

/* â”€â”€â”€ ROOM VIEW â”€â”€â”€ */
#room-container{flex:1;position:relative;overflow:hidden}
#room-bg{width:100%;height:100%;background-size:cover;background-position:center;
position:relative;transition:opacity .8s}
#room-bg::after{content:'';position:absolute;inset:0;
background:radial-gradient(ellipse at center,rgba(0,0,0,.15) 30%,rgba(0,0,0,.7) 100%);
pointer-events:none}
.room-obj{position:absolute;z-index:5;width:clamp(56px,10vw,80px);
height:clamp(56px,10vw,80px);border-radius:50%;display:flex;flex-direction:column;
align-items:center;justify-content:center;cursor:pointer;transition:.3s;
background:rgba(0,0,0,.55);border:2px solid rgba(245,197,24,.5);
backdrop-filter:blur(4px)}
.room-obj:hover{transform:scale(1.15);border-color:var(--gold);
box-shadow:0 0 25px rgba(245,197,24,.4)}
.room-obj.done{border-color:var(--green);opacity:.5;pointer-events:none}
.room-obj .emoji{font-size:clamp(1.3rem,3vw,1.8rem);line-height:1}
.room-obj .label{font-size:clamp(.5rem,1.2vw,.65rem);margin-top:2px;
text-align:center;color:var(--txt);font-weight:500}
.room-obj::before{content:'';position:absolute;inset:-6px;border-radius:50%;
border:2px solid rgba(245,197,24,.25);animation:objPulse 2.5s infinite}
.room-obj.done::before{display:none}
@keyframes objPulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.2);opacity:0}}

.door-lock{position:absolute;right:4%;top:50%;transform:translateY(-50%);z-index:6;
width:clamp(64px,11vw,90px);height:clamp(80px,14vw,110px);
background:linear-gradient(180deg,#3a2a10,#2a1c08);border:3px solid #6b4f2a;
border-radius:10px;display:flex;flex-direction:column;align-items:center;
justify-content:center;cursor:pointer;transition:.3s;box-shadow:0 4px 20px rgba(0,0,0,.6)}
.door-lock:hover{box-shadow:0 0 30px rgba(245,197,24,.3);border-color:var(--gold)}
.door-lock.unlocked{border-color:var(--green);box-shadow:0 0 30px rgba(63,185,80,.3)}
.door-lock .lock-icon{font-size:clamp(1.5rem,4vw,2.2rem)}
.door-lock .lock-label{font-size:clamp(.5rem,1.2vw,.65rem);color:var(--gold);
font-weight:600;margin-top:4px}
.code-dots{display:flex;gap:4px;margin-top:6px}
.code-dot{width:clamp(10px,2vw,14px);height:clamp(10px,2vw,14px);border-radius:50%;
background:#1a1a1a;border:1px solid #444;transition:.3s}
.code-dot.revealed{background:var(--gold);border-color:var(--gold);
box-shadow:0 0 8px rgba(245,197,24,.5)}

/* â”€â”€â”€ NARRATION â”€â”€â”€ */
#narration{background:rgba(10,14,23,.95);backdrop-filter:blur(10px);
border-top:1px solid rgba(245,197,24,.1);padding:14px 20px;display:flex;
align-items:flex-start;gap:14px;min-height:80px;flex-shrink:0}
.narrator-avatar{width:48px;height:48px;border-radius:50%;
background:linear-gradient(135deg,var(--gold),var(--gold2));display:flex;
align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0}
.narrator-text{flex:1;font-size:clamp(.82rem,1.8vw,.95rem);line-height:1.6;
color:var(--dim)}
.narrator-text strong{color:var(--gold)}
.narrator-text .highlight{color:var(--txt);font-weight:500}

/* â”€â”€â”€ MODAL â”€â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);
backdrop-filter:blur(6px);z-index:100;display:none;align-items:center;
justify-content:center;padding:16px}
.modal-overlay.active{display:flex}
.modal{background:var(--card);border:1px solid rgba(245,197,24,.15);
border-radius:16px;max-width:520px;width:100%;max-height:85vh;overflow-y:auto;
position:relative;animation:modalIn .3s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.9) translateY(20px)}
to{opacity:1;transform:scale(1) translateY(0)}}
.modal-close{position:absolute;top:12px;right:14px;background:none;color:var(--dim);
font-size:1.3rem;z-index:5;width:32px;height:32px;border-radius:50%;
display:flex;align-items:center;justify-content:center;transition:.2s}
.modal-close:hover{background:rgba(255,255,255,.1);color:var(--txt)}
.modal-img{width:100%;height:180px;object-fit:cover;border-radius:16px 16px 0 0}
.modal-body{padding:20px}
.modal-title{font-family:'Cinzel',serif;font-size:1.1rem;color:var(--gold);margin-bottom:12px}
.modal-text{font-size:.9rem;line-height:1.7;color:var(--dim);margin-bottom:18px}
.modal-text em{color:var(--gold);font-style:normal;font-weight:600}
.modal-q{background:var(--card2);border-radius:10px;padding:16px;
border:1px solid rgba(245,197,24,.08)}
.modal-q label{display:block;font-size:.85rem;font-weight:600;margin-bottom:10px;
color:var(--txt)}
.modal-q .input-row{display:flex;gap:8px}
.modal-q input{flex:1;padding:10px 14px;border-radius:8px;border:2px solid #2a3040;
background:#0d1117;color:var(--txt);font-size:.95rem;transition:.2s}
.modal-q input:focus{border-color:var(--gold)}
.modal-q input.correct{border-color:var(--green);background:rgba(63,185,80,.08)}
.modal-q input.wrong{border-color:var(--red);animation:shake .4s}
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-6px)}
40%,80%{transform:translateX(6px)}}
.btn-answer{background:var(--gold);color:var(--bg);font-weight:700;padding:10px 24px;
border-radius:8px;font-size:.9rem;transition:.2s;flex-shrink:0}
.btn-answer:hover{background:var(--gold2)}
.modal-feedback{margin-top:10px;font-size:.82rem;padding:8px 12px;border-radius:6px;
display:none}
.modal-feedback.show{display:block}
.modal-feedback.success{background:rgba(63,185,80,.1);color:var(--green);
border:1px solid rgba(63,185,80,.2)}
.modal-feedback.error{background:rgba(233,69,96,.1);color:var(--red);
border:1px solid rgba(233,69,96,.2)}

/* â”€â”€â”€ CODE MODAL â”€â”€â”€ */
.code-entry{text-align:center;padding:30px 20px}
.code-entry h3{font-family:'Cinzel',serif;color:var(--gold);margin-bottom:8px;font-size:1.1rem}
.code-entry p{color:var(--dim);font-size:.85rem;margin-bottom:20px}
.code-boxes{display:flex;gap:10px;justify-content:center;margin-bottom:20px}
.code-box{width:52px;height:60px;border:2px solid #2a3040;border-radius:10px;
background:#0d1117;color:var(--gold);font-family:'Cinzel',serif;font-size:1.6rem;
font-weight:700;text-align:center;line-height:56px;transition:.3s}
.code-box.filled{border-color:var(--gold);box-shadow:0 0 12px rgba(245,197,24,.2)}
.code-box.correct-box{border-color:var(--green);color:var(--green);
box-shadow:0 0 12px rgba(63,185,80,.3)}
.code-box.wrong-box{border-color:var(--red);animation:shake .4s}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-width:240px;
margin:0 auto 16px}
.key{background:var(--card2);color:var(--txt);font-size:1.1rem;font-weight:600;
padding:14px;border-radius:8px;transition:.15s;border:1px solid rgba(255,255,255,.05)}
.key:hover{background:var(--gold);color:var(--bg)}
.key-action{grid-column:span 1}
.key-clear{background:rgba(233,69,96,.15);color:var(--red)}
.key-clear:hover{background:var(--red);color:#fff}
.key-submit{background:rgba(63,185,80,.15);color:var(--green)}
.key-submit:hover{background:var(--green);color:#fff}
.code-feedback{font-size:.85rem;min-height:22px}

/* â”€â”€â”€ ROOM 3 FILL-IN â”€â”€â”€ */
.fill-container{padding:20px}
.fill-title{font-family:'Cinzel',serif;color:var(--gold);text-align:center;
margin-bottom:6px;font-size:1.15rem}
.fill-sub{text-align:center;color:var(--dim);font-size:.85rem;margin-bottom:24px}
.fill-sentence{background:var(--card2);border-radius:10px;padding:16px;
margin-bottom:12px;font-size:clamp(.85rem,2vw,1rem);line-height:1.8;display:flex;
flex-wrap:wrap;align-items:center;gap:6px;border:2px solid transparent;transition:.3s}
.fill-sentence.correct-sent{border-color:var(--green);background:rgba(63,185,80,.05)}
.fill-sentence.wrong-sent{border-color:var(--red);animation:shake .4s}
.fill-input{width:80px;padding:4px 10px;border-radius:6px;border:2px solid #2a3040;
background:#0d1117;color:var(--gold);font-size:.95rem;text-align:center;font-weight:600}
.fill-input:focus{border-color:var(--gold)}
.fill-input.correct-in{border-color:var(--green);color:var(--green);background:rgba(63,185,80,.05)}
.fill-input.wrong-in{border-color:var(--red);animation:shake .4s}
.btn-check-all{display:block;margin:20px auto 0;background:var(--gold);color:var(--bg);
font-weight:700;padding:14px 40px;border-radius:10px;font-size:1rem;
font-family:'Cinzel',serif;letter-spacing:1px;transition:.2s}
.btn-check-all:hover{background:var(--gold2);transform:scale(1.03)}

/* â”€â”€â”€ INVENTORY PANEL â”€â”€â”€ */
.inv-panel{position:fixed;top:0;right:-360px;width:340px;height:100%;
background:var(--card);border-left:1px solid rgba(245,197,24,.12);z-index:90;
transition:.4s;padding:20px;overflow-y:auto}
.inv-panel.open{right:0}
.inv-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:89;
display:none}
.inv-overlay.open{display:block}
.inv-title{font-family:'Cinzel',serif;color:var(--gold);font-size:1rem;
margin-bottom:16px;display:flex;justify-content:space-between;align-items:center}
.inv-close{background:none;color:var(--dim);font-size:1.3rem}
.inv-card{background:var(--card2);border-radius:8px;padding:12px;margin-bottom:10px;
border-left:3px solid var(--gold);font-size:.82rem;line-height:1.6;color:var(--dim)}
.inv-card strong{color:var(--txt)}
.inv-empty{color:var(--dim);font-size:.85rem;text-align:center;padding:30px 0}

/* â”€â”€â”€ VICTORY / GAME OVER â”€â”€â”€ */
#victory{background:linear-gradient(160deg,#0a1a0a,#0d1a12,#0a140a);
align-items:center;justify-content:center;text-align:center;padding:24px}
#victory::before{content:'';position:absolute;inset:0;
background:radial-gradient(circle at 50% 40%,rgba(63,185,80,.08),transparent 60%)}
.victory-icon{font-size:clamp(3rem,8vw,5rem);margin-bottom:16px;animation:bounce 1s infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
.victory-title{font-family:'Cinzel',serif;font-size:clamp(1.6rem,5vw,2.8rem);
font-weight:900;color:var(--green);margin-bottom:12px;
text-shadow:0 0 40px rgba(63,185,80,.3)}
.victory-sub{font-size:clamp(.85rem,2vw,1.05rem);color:var(--dim);max-width:500px;
line-height:1.8;margin-bottom:28px}
.victory-family{display:flex;gap:14px;justify-content:center;flex-wrap:wrap;margin-bottom:28px}
.victory-member{text-align:center}
.victory-member img{width:64px;height:64px;border-radius:50%;object-fit:cover;
border:3px solid var(--green);margin-bottom:6px}
.victory-member .vm-name{font-size:.78rem;font-weight:600}
.victory-time{background:var(--card);padding:10px 24px;border-radius:20px;
display:inline-block;font-size:.85rem;margin-bottom:20px;
border:1px solid rgba(63,185,80,.2)}
.btn-restart{background:var(--green);color:#fff;font-weight:700;padding:14px 36px;
border-radius:50px;font-size:1rem;transition:.2s}
.btn-restart:hover{transform:scale(1.05)}

#gameover{background:linear-gradient(160deg,#1a0a0a,#1a0d0d,#140a0a);
align-items:center;justify-content:center;text-align:center;padding:24px}
.go-icon{font-size:clamp(3rem,8vw,5rem);margin-bottom:16px}
.go-title{font-family:'Cinzel',serif;font-size:clamp(1.6rem,5vw,2.5rem);
color:var(--red);margin-bottom:12px;text-shadow:0 0 40px rgba(233,69,96,.3)}
.go-sub{color:var(--dim);font-size:1rem;margin-bottom:28px;max-width:400px;line-height:1.7}
.btn-retry{background:var(--red);color:#fff;font-weight:700;padding:14px 36px;
border-radius:50px;font-size:1rem;transition:.2s}
.btn-retry:hover{transform:scale(1.05)}

/* â”€â”€â”€ ROOM 3 CENTERED â”€â”€â”€ */
.room3-center{position:absolute;inset:0;z-index:5;display:flex;
align-items:center;justify-content:center;padding:16px}
.room3-card{background:rgba(21,27,43,.95);backdrop-filter:blur(10px);
border:1px solid rgba(245,197,24,.15);border-radius:16px;max-width:560px;
width:100%;padding:8px;max-height:85vh;overflow-y:auto}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
@media(max-width:600px){
  #topbar{padding:8px 12px}
  .tb-item{padding:4px 8px;font-size:.7rem}
  .tb-btn{padding:4px 10px;font-size:.7rem}
  .room-obj{width:52px;height:52px}
  .room-obj .emoji{font-size:1.1rem}
  .room-obj .label{font-size:.48rem}
  .door-lock{width:54px;height:70px}
  .door-lock .lock-icon{font-size:1.3rem}
  .door-lock .lock-label{font-size:.45rem}
  .code-dot{width:8px;height:8px}
  #narration{padding:10px 14px;min-height:64px}
  .narrator-avatar{width:36px;height:36px;font-size:1.1rem}
  .narrator-text{font-size:.78rem}
  .modal{max-width:100%;border-radius:12px}
  .modal-img{height:130px}
  .code-box{width:44px;height:50px;font-size:1.3rem;line-height:46px}
  .inv-panel{width:280px}
}

/* â”€â”€â”€ SPARKLE FOR VICTORY â”€â”€â”€ */
.sparkles{position:fixed;inset:0;pointer-events:none;z-index:5;overflow:hidden}
.sparkle{position:absolute;width:6px;height:6px;border-radius:50%;animation:fall linear forwards}
@keyframes fall{0%{transform:translateY(-10px) rotate(0deg);opacity:1}
100%{transform:translateY(100vh) rotate(720deg);opacity:0}}

/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--card2);border-radius:3px}
</style>
</head>
<body>

<!-- â•â•â•â•â•â• INTRO SCREEN â•â•â•â•â•â• -->
<div id="intro" class="screen active">
  <div class="intro-badge">ğŸ” Detective Case File #0042</div>
  <h1 class="intro-title">The Johnson Mystery</h1>
  <div class="intro-story">
    Detective Sam receives a strange message:<br>
    <em>"The Johnson family has vanished from their home."</em><br><br>
    Their house is locked. The only way to find them is to <em>learn everything about them</em> â€”
    who they are, where they are from, and what they love.<br><br>
    Can <em>you</em> solve the mystery?
  </div>
  <div class="intro-chars" id="introChars"></div>
  <button class="btn-start" onclick="startGame()">Begin Investigation</button>
</div>

<!-- â•â•â•â•â•â• GAME SCREEN â•â•â•â•â•â• -->
<div id="game" class="screen">
  <!-- Top Bar -->
  <div id="topbar">
    <div class="tb-room" id="tbRoom">Room 1</div>
    <div class="tb-group">
      <div class="tb-item"><span class="icon">â±ï¸</span><span id="timer">20:00</span></div>
      <div class="tb-item"><span class="icon">ğŸ’¡</span><span id="hintCount">3</span></div>
      <div class="tb-item"><span class="icon">ğŸƒ</span><span id="clueCount">0</span></div>
      <button class="tb-btn" onclick="useHint()">Hint</button>
      <button class="tb-btn" onclick="toggleInventory()">Clues</button>
    </div>
  </div>
  <!-- Room -->
  <div id="room-container">
    <div id="room-bg"></div>
  </div>
  <!-- Narration -->
  <div id="narration">
    <div class="narrator-avatar">ğŸ•µï¸</div>
    <div class="narrator-text" id="narratorText">Welcome, detective.</div>
  </div>
</div>

<!-- â•â•â•â•â•â• VICTORY â•â•â•â•â•â• -->
<div id="victory" class="screen">
  <div class="sparkles" id="sparkles"></div>
  <div class="victory-icon">ğŸ‰</div>
  <h1 class="victory-title">Case Solved!</h1>
  <div class="victory-sub">
    You found the Johnson family! They are safe and together again.
    <br>Great work, Detective!
  </div>
  <div class="victory-family" id="victoryFamily"></div>
  <div class="victory-time" id="victoryTime">Time: 00:00</div>
  <br>
  <button class="btn-restart" onclick="location.reload()">Play Again</button>
</div>

<!-- â•â•â•â•â•â• GAME OVER â•â•â•â•â•â• -->
<div id="gameover" class="screen">
  <div class="go-icon">â°</div>
  <h1 class="go-title">Time's Up!</h1>
  <div class="go-sub">The Johnson family is still missing. The mystery remains unsolvedâ€¦ Try again, Detective!</div>
  <button class="btn-retry" onclick="location.reload()">Try Again</button>
</div>

<!-- â•â•â•â•â•â• CLUE MODAL â•â•â•â•â•â• -->
<div class="modal-overlay" id="clueOverlay">
  <div class="modal" id="clueModal">
    <button class="modal-close" onclick="closeClueModal()">âœ•</button>
    <img class="modal-img" id="clueImg" src="" alt="Clue">
    <div class="modal-body">
      <div class="modal-title" id="clueTitle"></div>
      <div class="modal-text" id="clueText"></div>
      <div class="modal-q" id="clueQuestion">
        <label id="clueQLabel"></label>
        <div class="input-row">
          <input type="text" id="clueQInput" placeholder="Type your answer..." autocomplete="off">
          <button class="btn-answer" onclick="submitClueAnswer()">Check</button>
        </div>
        <div class="modal-feedback" id="clueFeedback"></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• CODE MODAL â•â•â•â•â•â• -->
<div class="modal-overlay" id="codeOverlay">
  <div class="modal">
    <button class="modal-close" onclick="closeCodeModal()">âœ•</button>
    <div class="code-entry">
      <h3>ğŸ”’ Enter the Code</h3>
      <p id="codeHintText">Answer all questions to reveal the code!</p>
      <div class="code-boxes" id="codeBoxes"></div>
      <div class="keypad" id="keypad"></div>
      <div class="code-feedback" id="codeFeedback"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• ROOM 3 MODAL â•â•â•â•â•â• -->
<div class="modal-overlay" id="room3Overlay">
  <div class="modal" style="max-width:580px">
    <button class="modal-close" onclick="closeRoom3Modal()">âœ•</button>
    <div class="fill-container">
      <div class="fill-title">ğŸ” The Final Challenge</div>
      <div class="fill-sub">Complete the sentences about the Johnson family.<br>Use the verb TO BE: <strong>am, is, are</strong></div>
      <div id="fillSentences"></div>
      <div class="modal-feedback" id="fillFeedback" style="text-align:center;margin-top:10px"></div>
      <button class="btn-check-all" onclick="checkFillBlanks()">âœ“ Check Answers</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• INVENTORY PANEL â•â•â•â•â•â• -->
<div class="inv-overlay" id="invOverlay" onclick="toggleInventory()"></div>
<div class="inv-panel" id="invPanel">
  <div class="inv-title">
    <span>ğŸƒ Clue Cards</span>
    <button class="inv-close" onclick="toggleInventory()">âœ•</button>
  </div>
  <div id="invCards"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHARACTERS = [
  { name:'Tom Johnson', role:'Father, 45', img:'https://source.unsplash.com/200x200/?man,suit,portrait', age:45, from:'London', color:'blue', animal:'dog' },
  { name:'Mary Johnson', role:'Mother, 42', img:'https://source.unsplash.com/200x200/?woman,elegant,portrait', age:42, from:'Paris', color:'red', animal:'cat' },
  { name:'Leo Johnson', role:'Son, 16', img:'https://source.unsplash.com/200x200/?teenager,boy,portrait', age:16, from:'London', color:'', animal:'turtle' },
  { name:'Emma Johnson', role:'Daughter, 12', img:'https://source.unsplash.com/200x200/?young,girl,portrait', age:12, from:'London', color:'pink', animal:'horse' }
];

const ROOMS = {
  1: {
    name: 'Room 1 â€” The Living Room ğŸ›‹ï¸',
    bg: 'https://source.unsplash.com/800x500/?cozy,livingroom,warm',
    bgFallback: 'linear-gradient(135deg,#2d1f0e,#4a3520,#2d1f0e)',
    intro: "You enter the Johnson family's living room. It feels <strong>warm</strong> but empty. Look around â€” there are <strong>clues</strong> everywhere! Click on the glowing objects to investigate.",
    code: '4215',
    hints: [
      "ğŸ’¡ Look at the family photo carefully. What color is Tom's shirt?",
      "ğŸ’¡ The letter mentions someone's birthday. How old is she?",
      "ğŸ’¡ Check the calendar. Where does Tom fly from?"
    ],
    objects: [
      {
        emoji:'ğŸ“¸', label:'Photo', top:'20%', left:'12%',
        img:'https://source.unsplash.com/400x300/?family,photo,portrait',
        title:'ğŸ“¸ Family Photo',
        text:'You find a family photo on the wall. Tom Johnson is smiling. He is wearing a <em>blue</em> shirt. He always wears blue â€” it is his <em>favorite color</em>!',
        question:'What is Tom\'s favorite color?',
        answer:'blue',
        clue:'Tom\'s favorite color is blue.',
        wrongHint:'Look at Tom\'s shirt in the photo. What color is it?',
        digit: 0
      },
      {
        emoji:'âœ‰ï¸', label:'Letter', top:'55%', left:'30%',
        img:'https://source.unsplash.com/400x300/?letter,handwritten,paper',
        title:'âœ‰ï¸ A Birthday Letter',
        text:'"Dear Mary,<br>Happy <em>42nd</em> Birthday!<br>With all my love, Tom.<br>P.S. I remember when we first met in Paris."',
        question:'How old is Mary?',
        answer:'42',
        clue:'Mary is 42 years old.',
        wrongHint:'Read the letter again. It says "Happy ___th Birthday".',
        digit: 1
      },
      {
        emoji:'ğŸ“…', label:'Calendar', top:'18%', left:'62%',
        img:'https://source.unsplash.com/400x300/?calendar,wall',
        title:'ğŸ“… Wall Calendar',
        text:'The calendar has a note written in pen: "<em>Tom\'s flight: London â†’ Home</em>." Tom misses his hometown. Tom is from <em>London</em>!',
        question:'Where is Tom from?',
        answer:'london',
        clue:'Tom is from London.',
        wrongHint:'Check the calendar. What city does the flight depart from?',
        digit: 2
      },
      {
        emoji:'ğŸ•', label:'Collar', top:'65%', left:'70%',
        img:'https://source.unsplash.com/400x300/?dog,collar,pet',
        title:'ğŸ• Dog Collar',
        text:'You find a dog collar on the sofa. The tag says: "<em>Max</em> â€” Tom\'s best friend." Tom\'s favorite animal is a <em>dog</em>!',
        question:'What is Tom\'s favorite animal?',
        answer:'dog',
        clue:'Tom\'s favorite animal is a dog.',
        wrongHint:'Read the collar tag. What kind of animal is Max?',
        digit: 3
      }
    ]
  },
  2: {
    name: 'Room 2 â€” The Bedrooms ğŸ›ï¸',
    bg: 'https://source.unsplash.com/800x500/?bedroom,cozy,interior',
    bgFallback: 'linear-gradient(135deg,#1a1a2e,#16213e,#1a1a2e)',
    intro: "You enter the bedrooms. Each family member has personal things here. Search for <strong>diaries, photos, and notebooks</strong> to learn more about the family!",
    code: '7382',
    hints: [
      "ğŸ’¡ Leo writes about his pet in his diary. What kind of animal is it?",
      "ğŸ’¡ Look at Emma's photo frame. How old is she now?",
      "ğŸ’¡ Mary paints with one color. What color does she love?"
    ],
    objects: [
      {
        emoji:'ğŸ“”', label:'Diary', top:'35%', left:'10%',
        img:'https://source.unsplash.com/400x300/?diary,journal,book',
        title:'ğŸ“” Leo\'s Diary',
        text:'"Today I fed my <em>turtle</em>, Shelly. Turtles are the best animals in the world! I am 16 years old, and Shelly is my best friend." â€” Leo',
        question:'What is Leo\'s favorite animal?',
        answer:'turtle',
        clue:'Leo\'s favorite animal is a turtle.',
        wrongHint:'Leo writes about feeding his pet. What kind of pet is Shelly?',
        digit: 0
      },
      {
        emoji:'ğŸ–¼ï¸', label:'Pet Photo', top:'22%', left:'40%',
        img:'https://source.unsplash.com/400x300/?horse,girl,pet',
        title:'ğŸ–¼ï¸ Emma\'s Photo',
        text:'A photo on the nightstand shows a young girl riding a horse. The frame says: "<em>Emma â™¥ Star</em> â€” Best friends since Emma was 10. Now she is <em>12</em>!"',
        question:'How old is Emma?',
        answer:'12',
        clue:'Emma is 12 years old. She loves horses.',
        wrongHint:'Read the frame text. It says "Now she is ___!"',
        digit: 1
      },
      {
        emoji:'ğŸ““', label:'Notebook', top:'55%', left:'55%',
        img:'https://source.unsplash.com/400x300/?art,notebook,red,painting',
        title:'ğŸ““ Mary\'s Art Notebook',
        text:'You find Mary\'s art notebook. Every page is painted in <em>RED</em>. A note says: "<em>Red</em> is the color of love. Red is my <em>favorite color</em>!" â€” Mary',
        question:'What is Mary\'s favorite color?',
        answer:'red',
        clue:'Mary\'s favorite color is red.',
        wrongHint:'Look at the paintings. What color does Mary use most?',
        digit: 2
      },
      {
        emoji:'ğŸ¨', label:'Drawing', top:'65%', left:'22%',
        img:'https://source.unsplash.com/400x300/?child,drawing,crayon',
        title:'ğŸ¨ A Family Drawing',
        text:'A child\'s drawing shows four people: "Dad Tom, Mom Mary, brother Leo, and me â€” <em>Emma</em>!" Emma is Tom\'s <em>daughter</em>.',
        question:'Who is Tom\'s daughter?',
        answer:'emma',
        clue:'Emma is Tom\'s daughter. Leo is Tom\'s son.',
        wrongHint:'Look at who drew this picture. She writes "me â€” ___!"',
        digit: 3
      }
    ]
  },
  3: {
    name: 'Room 3 â€” The Secret Room ğŸ”',
    bg: 'https://source.unsplash.com/800x500/?dark,mysterious,room,door',
    bgFallback: 'linear-gradient(135deg,#0d0d1a,#1a0d1a,#0d0d0d)',
    intro: "You found a <strong>secret room</strong>! The last lock needs the correct <strong>grammar</strong> to open. Complete the sentences using <strong>am, is,</strong> or <strong>are</strong>. This is your <strong>final challenge</strong>!",
    hints: [
      "ğŸ’¡ Use IS for one person or thing: Tom IS, Mary IS, it IS.",
      "ğŸ’¡ Use ARE for two or more people: They ARE, We ARE, Tom and Mary ARE.",
      "ğŸ’¡ Use AM only with I: I AM a detective."
    ],
    sentences: [
      { parts:['Tom','___','45 years old.'], answer:'is' },
      { parts:['Mary and Tom','___','the parents.'], answer:'are' },
      { parts:['Emma\'s favorite animal','___','a horse.'], answer:'is' },
      { parts:['Leo','___','16 years old.'], answer:'is' },
      { parts:['The children','___','Leo and Emma.'], answer:'are' }
    ]
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  room: 0,
  timer: 1200,
  timerInterval: null,
  hints: {1:3, 2:3, 3:3},
  clues: [],
  answered: {1:[false,false,false,false], 2:[false,false,false,false]},
  currentObj: null,
  codeInput: '',
  startTime: 0
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  // Render intro characters
  const cc = document.getElementById('introChars');
  CHARACTERS.forEach(c => {
    cc.innerHTML += `<div class="intro-char">
      <img src="${c.img}" alt="${c.name}" onerror="this.style.background='var(--card2)'">
      <div class="name">${c.name}</div>
      <div class="role">${c.role}</div>
    </div>`;
  });
}
init();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function startGame() {
  state.startTime = Date.now();
  state.room = 1;
  showScreen('game');
  enterRoom(1);
  startTimer();
}

function enterRoom(num) {
  state.room = num;
  const room = ROOMS[num];

  // Update top bar
  document.getElementById('tbRoom').textContent = room.name;
  document.getElementById('hintCount').textContent = state.hints[num];

  // Set background
  const bg = document.getElementById('room-bg');
  bg.style.backgroundImage = `url('${room.bg}')`;
  bg.style.background = room.bgFallback;
  bg.style.backgroundImage = `url('${room.bg}')`;
  bg.style.backgroundSize = 'cover';
  bg.style.backgroundPosition = 'center';
  bg.innerHTML = '';

  if (num <= 2) {
    // Render objects
    room.objects.forEach((obj, i) => {
      const done = state.answered[num][i];
      const el = document.createElement('div');
      el.className = 'room-obj' + (done ? ' done' : '');
      el.style.top = obj.top;
      el.style.left = obj.left;
      el.innerHTML = `<span class="emoji">${obj.emoji}</span><span class="label">${obj.label}</span>`;
      if (!done) el.onclick = () => openClueModal(num, i);
      bg.appendChild(el);
    });

    // Render door lock
    const door = document.createElement('div');
    door.className = 'door-lock';
    door.onclick = () => openCodeModal(num);
    const revealedCount = state.answered[num].filter(Boolean).length;
    const allDone = revealedCount === room.objects.length;
    if (allDone) door.classList.add('unlocked');
    door.innerHTML = `
      <span class="lock-icon">${allDone ? 'ğŸ”“' : 'ğŸ”’'}</span>
      <span class="lock-label">${allDone ? 'OPEN' : 'LOCKED'}</span>
      <div class="code-dots">${room.code.split('').map((_, i) =>
        `<span class="code-dot ${state.answered[num][i] ? 'revealed' : ''}"></span>`
      ).join('')}</div>`;
    bg.appendChild(door);
  } else {
    // Room 3 â€” final challenge
    const center = document.createElement('div');
    center.className = 'room3-center';
    const card = document.createElement('div');
    card.className = 'room3-card';
    card.innerHTML = `<div style="padding:4px;text-align:center">
      <button class="btn-answer" style="margin:16px auto;padding:14px 32px;font-size:1rem;border-radius:10px"
        onclick="openRoom3Modal()">ğŸ” Open Final Challenge</button>
    </div>`;
    center.appendChild(card);
    bg.appendChild(center);
  }

  // Narration
  setNarration(room.intro);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startTimer() {
  state.timerInterval = setInterval(() => {
    state.timer--;
    if (state.timer <= 0) {
      clearInterval(state.timerInterval);
      gameOver();
      return;
    }
    const m = Math.floor(state.timer / 60);
    const s = state.timer % 60;
    const el = document.getElementById('timer');
    el.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    if (state.timer <= 120) el.classList.add('warning');
    else el.classList.remove('warning');
  }, 1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NARRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setNarration(html) {
  const el = document.getElementById('narratorText');
  el.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLUE MODAL (Rooms 1 & 2)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openClueModal(room, objIdx) {
  state.currentObj = { room, idx: objIdx };
  const obj = ROOMS[room].objects[objIdx];

  document.getElementById('clueImg').src = obj.img;
  document.getElementById('clueTitle').textContent = obj.title;
  document.getElementById('clueText').innerHTML = obj.text;
  document.getElementById('clueQLabel').textContent = 'â“ ' + obj.question;
  document.getElementById('clueQInput').value = '';
  document.getElementById('clueQInput').className = '';
  document.getElementById('clueQInput').disabled = false;

  const fb = document.getElementById('clueFeedback');
  fb.className = 'modal-feedback';
  fb.textContent = '';

  // If already answered, show completed state
  if (state.answered[room][objIdx]) {
    document.getElementById('clueQInput').value = obj.answer;
    document.getElementById('clueQInput').classList.add('correct');
    document.getElementById('clueQInput').disabled = true;
    fb.className = 'modal-feedback show success';
    fb.textContent = 'âœ“ Correct! Clue card collected.';
  }

  document.getElementById('clueOverlay').classList.add('active');
  if (!state.answered[room][objIdx]) {
    setTimeout(() => document.getElementById('clueQInput').focus(), 300);
  }
}

function closeClueModal() {
  document.getElementById('clueOverlay').classList.remove('active');
  state.currentObj = null;
}

function submitClueAnswer() {
  if (!state.currentObj) return;
  const { room, idx } = state.currentObj;
  if (state.answered[room][idx]) return;

  const obj = ROOMS[room].objects[idx];
  const input = document.getElementById('clueQInput');
  const val = input.value.trim().toLowerCase();
  const fb = document.getElementById('clueFeedback');

  if (val === obj.answer.toLowerCase()) {
    // Correct!
    state.answered[room][idx] = true;
    input.classList.add('correct');
    input.disabled = true;
    fb.className = 'modal-feedback show success';
    fb.textContent = 'âœ… Correct! Clue card collected!';

    // Add clue card
    state.clues.push(obj.clue);
    document.getElementById('clueCount').textContent = state.clues.length;

    // Update room after a moment
    setTimeout(() => {
      closeClueModal();
      enterRoom(room); // Re-render room
      const done = state.answered[room].every(Boolean);
      if (done) {
        setNarration("All clues found! Click the <strong>door lock</strong> to enter the code and unlock the next room! ğŸ”“");
      } else {
        const remaining = state.answered[room].filter(x => !x).length;
        setNarration(`Great work! <strong>${remaining}</strong> more clue${remaining>1?'s':''} to find. Keep searching! ğŸ”`);
      }
    }, 1200);
  } else {
    // Wrong
    input.classList.remove('wrong');
    void input.offsetWidth;
    input.classList.add('wrong');
    fb.className = 'modal-feedback show error';
    fb.textContent = 'âŒ Not quite! ' + obj.wrongHint;
    setTimeout(() => input.classList.remove('wrong'), 500);
  }
}

// Enter key support
document.getElementById('clueQInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') submitClueAnswer();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CODE MODAL (Rooms 1 & 2)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCodeModal(room) {
  const roomData = ROOMS[room];
  const allDone = state.answered[room].every(Boolean);

  // Build code boxes
  const boxes = document.getElementById('codeBoxes');
  boxes.innerHTML = '';
  roomData.code.split('').forEach((digit, i) => {
    const box = document.createElement('div');
    box.className = 'code-box';
    if (state.answered[room][i]) {
      box.textContent = digit;
      box.classList.add('filled');
    } else {
      box.textContent = '?';
    }
    boxes.appendChild(box);
  });

  const hintEl = document.getElementById('codeHintText');
  if (allDone) {
    hintEl.textContent = 'The code is revealed! Enter it below to unlock the door.';
  } else {
    const need = state.answered[room].filter(x => !x).length;
    hintEl.textContent = `Answer ${need} more question${need>1?'s':''} to reveal the full code.`;
  }

  // Build keypad
  const keypad = document.getElementById('keypad');
  keypad.innerHTML = '';
  for (let i = 1; i <= 9; i++) {
    keypad.innerHTML += `<button class="key" onclick="codeKey('${i}')">${i}</button>`;
  }
  keypad.innerHTML += `<button class="key key-action key-clear" onclick="codeClear()">âŒ«</button>`;
  keypad.innerHTML += `<button class="key" onclick="codeKey('0')">0</button>`;
  keypad.innerHTML += `<button class="key key-action key-submit" onclick="codeSubmit()">âœ“</button>`;

  state.codeInput = '';
  document.getElementById('codeFeedback').textContent = '';
  document.getElementById('codeOverlay').classList.add('active');
}

function closeCodeModal() {
  document.getElementById('codeOverlay').classList.remove('active');
}

function codeKey(digit) {
  const room = state.room;
  const code = ROOMS[room].code;
  if (state.codeInput.length >= code.length) return;
  state.codeInput += digit;
  updateCodeDisplay();
}

function codeClear() {
  state.codeInput = state.codeInput.slice(0, -1);
  updateCodeDisplay();
}

function updateCodeDisplay() {
  const boxes = document.getElementById('codeBoxes').children;
  const room = state.room;
  const code = ROOMS[room].code;
  for (let i = 0; i < code.length; i++) {
    if (state.answered[room][i]) {
      // Revealed digit
      if (i < state.codeInput.length) {
        boxes[i].textContent = state.codeInput[i];
        boxes[i].className = 'code-box filled';
      } else {
        boxes[i].textContent = code[i];
        boxes[i].className = 'code-box filled';
      }
    } else {
      boxes[i].textContent = i < state.codeInput.length ? state.codeInput[i] : '?';
      boxes[i].className = 'code-box' + (i < state.codeInput.length ? ' filled' : '');
    }
  }
}

function codeSubmit() {
  const room = state.room;
  const code = ROOMS[room].code;
  const allDone = state.answered[room].every(Boolean);

  if (!allDone) {
    document.getElementById('codeFeedback').textContent = 'âš ï¸ Find all clues first!';
    document.getElementById('codeFeedback').style.color = 'var(--red)';
    return;
  }

  if (state.codeInput === code) {
    // Correct code!
    const boxes = document.getElementById('codeBoxes').children;
    for (let b of boxes) b.classList.add('correct-box');
    document.getElementById('codeFeedback').textContent = 'ğŸ”“ Door unlocked!';
    document.getElementById('codeFeedback').style.color = 'var(--green)';

    setTimeout(() => {
      closeCodeModal();
      const nextRoom = room + 1;
      if (nextRoom <= 3) {
        enterRoom(nextRoom);
      }
    }, 1500);
  } else {
    // Wrong code
    const boxes = document.getElementById('codeBoxes').children;
    for (let b of boxes) { b.classList.remove('wrong-box'); void b.offsetWidth; b.classList.add('wrong-box'); }
    document.getElementById('codeFeedback').textContent = 'âŒ Wrong code! Try again.';
    document.getElementById('codeFeedback').style.color = 'var(--red)';
    setTimeout(() => {
      state.codeInput = '';
      updateCodeDisplay();
      for (let b of boxes) b.classList.remove('wrong-box');
    }, 800);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROOM 3 â€” FILL IN THE BLANKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openRoom3Modal() {
  const sentences = ROOMS[3].sentences;
  const container = document.getElementById('fillSentences');
  container.innerHTML = '';

  sentences.forEach((s, i) => {
    const div = document.createElement('div');
    div.className = 'fill-sentence';
    div.id = `fill-${i}`;
    s.parts.forEach(part => {
      if (part === '___') {
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.className = 'fill-input';
        inp.id = `fill-input-${i}`;
        inp.placeholder = '___';
        inp.autocomplete = 'off';
        div.appendChild(inp);
      } else {
        const span = document.createElement('span');
        span.textContent = part + ' ';
        div.appendChild(span);
      }
    });
    container.appendChild(div);
  });

  document.getElementById('fillFeedback').className = 'modal-feedback';
  document.getElementById('fillFeedback').textContent = '';
  document.getElementById('room3Overlay').classList.add('active');
  setTimeout(() => {
    const first = document.getElementById('fill-input-0');
    if (first) first.focus();
  }, 300);
}

function closeRoom3Modal() {
  document.getElementById('room3Overlay').classList.remove('active');
}

function checkFillBlanks() {
  const sentences = ROOMS[3].sentences;
  let allCorrect = true;
  const fb = document.getElementById('fillFeedback');

  sentences.forEach((s, i) => {
    const inp = document.getElementById(`fill-input-${i}`);
    const sent = document.getElementById(`fill-${i}`);
    const val = inp.value.trim().toLowerCase();

    inp.classList.remove('correct-in', 'wrong-in');
    sent.classList.remove('correct-sent', 'wrong-sent');

    if (val === s.answer) {
      inp.classList.add('correct-in');
      sent.classList.add('correct-sent');
    } else {
      inp.classList.add('wrong-in');
      sent.classList.add('wrong-sent');
      allCorrect = false;
    }
  });

  if (allCorrect) {
    fb.className = 'modal-feedback show success';
    fb.innerHTML = 'ğŸ‰ All correct! You solved the mystery!';
    setTimeout(() => {
      closeRoom3Modal();
      victory();
    }, 2000);
  } else {
    fb.className = 'modal-feedback show error';
    fb.innerHTML = 'âŒ Some answers are wrong. Remember: use <strong>IS</strong> for one, <strong>ARE</strong> for two or more!';
    setTimeout(() => {
      sentences.forEach((_, i) => {
        const inp = document.getElementById(`fill-input-${i}`);
        const sent = document.getElementById(`fill-${i}`);
        if (inp.classList.contains('wrong-in')) {
          inp.classList.remove('wrong-in');
          sent.classList.remove('wrong-sent');
        }
      });
    }, 1500);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HINTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function useHint() {
  const room = state.room;
  if (!state.hints[room] || state.hints[room] <= 0) {
    setNarration("No more hints for this room! You can do it, Detective! ğŸ’ª");
    return;
  }
  const hintIdx = (ROOMS[room].hints.length) - state.hints[room];
  state.hints[room]--;
  document.getElementById('hintCount').textContent = state.hints[room];
  setNarration(ROOMS[room].hints[hintIdx]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INVENTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleInventory() {
  const panel = document.getElementById('invPanel');
  const overlay = document.getElementById('invOverlay');
  const isOpen = panel.classList.contains('open');

  if (isOpen) {
    panel.classList.remove('open');
    overlay.classList.remove('open');
  } else {
    // Render cards
    const container = document.getElementById('invCards');
    if (state.clues.length === 0) {
      container.innerHTML = '<div class="inv-empty">No clue cards yet.<br>Examine objects to collect clues!</div>';
    } else {
      container.innerHTML = '';
      state.clues.forEach((clue, i) => {
        container.innerHTML += `<div class="inv-card"><strong>Clue #${i+1}:</strong> ${clue}</div>`;
      });
    }
    panel.classList.add('open');
    overlay.classList.add('open');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VICTORY & GAME OVER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function victory() {
  clearInterval(state.timerInterval);
  showScreen('victory');

  // Time
  const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
  const m = Math.floor(elapsed / 60);
  const s = elapsed % 60;
  document.getElementById('victoryTime').textContent =
    `â±ï¸ Time: ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

  // Family
  const fam = document.getElementById('victoryFamily');
  fam.innerHTML = '';
  CHARACTERS.forEach(c => {
    fam.innerHTML += `<div class="victory-member">
      <img src="${c.img}" alt="${c.name}" onerror="this.style.background='var(--card2)'">
      <div class="vm-name">${c.name}</div>
    </div>`;
  });

  // Sparkles
  createSparkles();
}

function gameOver() {
  clearInterval(state.timerInterval);
  showScreen('gameover');
}

function createSparkles() {
  const container = document.getElementById('sparkles');
  container.innerHTML = '';
  const colors = ['#f5c518','#3fb950','#58a6ff','#e94560','#fff'];
  for (let i = 0; i < 60; i++) {
    const s = document.createElement('div');
    s.className = 'sparkle';
    s.style.left = Math.random() * 100 + '%';
    s.style.top = '-10px';
    s.style.width = (3 + Math.random() * 5) + 'px';
    s.style.height = s.style.width;
    s.style.background = colors[Math.floor(Math.random() * colors.length)];
    s.style.animationDuration = (2 + Math.random() * 4) + 's';
    s.style.animationDelay = Math.random() * 3 + 's';
    container.appendChild(s);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD SHORTCUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e => {
  if (document.getElementById('codeOverlay').classList.contains('active')) {
    if (e.key >= '0' && e.key <= '9') codeKey(e.key);
    else if (e.key === 'Backspace') codeClear();
    else if (e.key === 'Enter') codeSubmit();
  }
  if (document.getElementById('room3Overlay').classList.contains('active')) {
    if (e.key === 'Enter') checkFillBlanks();
  }
});
</script>
</body>
</html>
